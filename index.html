<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Capturador PRO ‚Äì Scanner con Linterna Autom√°tica</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f1f5f9;color:#0f172a}
.wrap{max-width:480px;margin:auto;padding:14px}
.card{background:#fff;border-radius:20px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
h2{text-align:center;margin:0 0 10px;font-size:18px}

input,button{
 width:100%;padding:14px;margin-top:10px;
 border-radius:14px;border:1px solid #e2e8f0;font-size:15px
}
button{border:none;font-weight:700}
.secondary{background:#64748b;color:#fff}
.success{background:#22c55e;color:#fff}
.danger{background:#ef4444;color:#fff}
.primary{background:#0ea5e9;color:#fff}
.qrbtn{width:64px;background:#22c55e;color:#fff;font-size:22px}

.field{display:flex;gap:8px}
.field input{flex:1}

.item{background:#f8fafc;padding:12px;border-radius:14px;margin-top:8px;cursor:pointer}
.small{font-size:12px;color:#475569}
.actions{display:flex;gap:8px;margin-top:6px}

/* SCANNER */
#scannerBox{
 display:none;
 position:relative;
 margin-top:12px;
 height:260px;
 border-radius:18px;
 overflow:hidden;
 background:#000
}
.scan-frame{position:absolute;inset:0;border:2px solid rgba(255,0,0,.6)}
.scan-line{
 position:absolute;left:0;right:0;
 height:2px;background:red;
 animation:scan 2s linear infinite
}
@keyframes scan{0%{top:0}50%{top:95%}100%{top:0}}

.scanner-controls{
 position:absolute;
 bottom:10px;left:10px;right:10px;
 display:flex;gap:10px
}
.ctrl{flex:1;padding:10px;border-radius:12px;font-size:14px}
</style>
</head>

<body>

<audio id="beep">
 <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg">
</audio>

<div class="wrap">
 <div class="card">
  <h2>üìã Capturador PRO</h2>

  <input id="operador" placeholder="Operador">
  <input id="ubicacion" placeholder="Ubicaci√≥n">

  <div class="field">
   <input id="codigo" placeholder="C√≥digo">
   <button class="qrbtn" onclick="scanCodigo()">üì∑</button>
  </div>

  <input id="descripcion" placeholder="Descripci√≥n">
  <input id="cantidad" type="number" value="1">

  <button id="btnGuardar" class="secondary" onclick="guardar()">‚ûï Ingresar</button>

  <div id="scannerBox">
   <div class="scan-frame"></div>
   <div class="scan-line"></div>
   <div class="scanner-controls">
    <button class="ctrl success" onclick="toggleTorch()">üî¶ Linterna</button>
    <button class="ctrl danger" onclick="cerrarScanner()">‚ùå Cerrar</button>
   </div>
  </div>

  <div id="lista"></div>

  <button class="success" onclick="exportarExcel()">üìä Exportar Excel</button>
  <button class="primary" onclick="exportarPDF()">üìÑ Exportar PDF</button>
  <button class="danger" onclick="finalizar()">‚ùå Finalizar</button>
 </div>
</div>

<script>
let capturas = JSON.parse(localStorage.getItem("capturas")||"[]");
let editIndex = null;
let scanner = null;
let torch = true; // üî• ARRANCA ENCENDIDA

render();

function scanCodigo(){
 abrirScanner();
}

function abrirScanner(){
 if(scanner) return;
 scannerBox.style.display="block";
 scanner = new Html5Qrcode("scannerBox");

 scanner.start(
  {facingMode:"environment"},
  {fps:10, qrbox:250},
  txt=>{
    beep.play();
    navigator.vibrate?.(200);
    codigo.value = txt;
    cerrarScanner();
  }
 ).then(()=>{
  // üî¶ ENCENDER LINTERN√Å AUTOM√ÅTICAMENTE
  scanner.applyVideoConstraints({
    advanced:[{torch:true}]
  }).catch(()=>{});
 });
}

function cerrarScanner(){
 if(!scanner) return;
 scanner.stop().then(()=>{
  scanner.clear();
  scanner=null;
  scannerBox.style.display="none";
 });
}

function toggleTorch(){
 torch=!torch;
 scanner?.applyVideoConstraints({
  advanced:[{torch:torch}]
 }).catch(()=>{});
}

function guardar(){
 const reg={
  Operador:operador.value,
  Ubicaci√≥n:ubicacion.value,
  C√≥digo:codigo.value,
  Descripci√≥n:descripcion.value,
  Cantidad:cantidad.value,
  Fecha:new Date().toLocaleString()
 };

 if(editIndex===null){
  capturas.push(reg);
 }else{
  capturas[editIndex]=reg;
  editIndex=null;
  btnGuardar.textContent="‚ûï Ingresar";
 }

 localStorage.setItem("capturas",JSON.stringify(capturas));
 limpiar();
 render();
}

function render(){
 lista.innerHTML="";
 capturas.forEach((c,i)=>{
  lista.innerHTML+=`
   <div class="item" onclick="editar(${i})">
    <b>${c.C√≥digo}</b> ‚Äì ${c.Descripci√≥n}<br>
    <span class="small">${c.Ubicaci√≥n} | ${c.Operador} | ${c.Cantidad}</span>
    <div class="actions">
     <button class="danger" onclick="event.stopPropagation();eliminar(${i})">‚ùå</button>
    </div>
   </div>`;
 });
}

function editar(i){
 const c=capturas[i];
 operador.value=c.Operador;
 ubicacion.value=c.Ubicaci√≥n;
 codigo.value=c.C√≥digo;
 descripcion.value=c.Descripci√≥n;
 cantidad.value=c.Cantidad;
 editIndex=i;
 btnGuardar.textContent="üíæ Guardar";
}

function eliminar(i){
 if(confirm("¬øEliminar registro?")){
  capturas.splice(i,1);
  localStorage.setItem("capturas",JSON.stringify(capturas));
  render();
 }
}

function limpiar(){
 codigo.value="";
 descripcion.value="";
 cantidad.value=1;
}

function exportarExcel(){
 if(!capturas.length)return;
 const ws=XLSX.utils.json_to_sheet(capturas);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Captura");
 XLSX.writeFile(wb,"captura_pro.xlsx");
}

function exportarPDF(){
 if(!capturas.length)return;
 const w=window.open("");
 let html="<h3>Reporte</h3><table border='1'><tr>";
 Object.keys(capturas[0]).forEach(k=>html+="<th>"+k+"</th>");
 html+="</tr>";
 capturas.forEach(r=>{
  html+="<tr>";
  Object.values(r).forEach(v=>html+="<td>"+v+"</td>");
  html+="</tr>";
 });
 html+="</table>";
 w.document.write(html);
 w.print();
}

function finalizar(){
 exportarExcel();
 localStorage.clear();
 setTimeout(()=>location.reload(),800);
}
</script>

</body>
</html>
